# 58. Datastoreの概要

## Datastoreとは？

Google Cloud の **スケーラブルな NoSQL データベースサービス**。主に Web アプリやモバイルアプリ向けに設計されています。

- **高いスケーラビリティ**
- **グローバルに分散された構造**
- **非リレーショナル（NoSQL）型データベース**
- 書き込みや読み込みの整合性は選択可能（強整合性 / 結果整合性）

---

## NoSQL とリレーショナルDBの違い

| リレーショナルDB         | NoSQL (例: Datastore)       |
|---------------------------|-----------------------------|
| スキーマに厳密            | 柔軟なデータ構造             |
| 強整合性が標準            | 結果整合性も選択可能         |
| 垂直スケーリングに強い    | 水平スケーリングが得意       |
| テーブル・行・列の概念     | 名前空間・カインド・エンティティ・プロパティ |

---

## Datastoreの構造

- **ネームスペース（Namespace）**: スキーマのような役割
- **カインド（Kind）**: テーブルに相当
- **エンティティ（Entity）**: 行に相当
- **プロパティ（Property）**: 列（カラム）のようなもの

### エンティティの構成例（パーソン）

| 名前（Name） | 年齢（Age） |
|--------------|-------------|
| 田中         | 30歳        |
| 佐藤         | 40歳        |
| 高橋         | 20歳        |

### エンティティの祖先（親子関係）

- ジョブエンティティ（例: ティーチャー、セールス）がパーソンエンティティ（例: 佐藤）に紐づけられる
- 祖先キーによって階層的な関係を表現できる（トランザクションにも使用可能）

---

## モードの違いと選択

- **Datastoreモード**
  - 従来のDatastoreと互換性あり
- **Firestoreモード**
  - Datastoreの後継（将来的には自動移行予定）

> プロジェクトごとにモードを最初に選択し、後から変更は不可

---

## データアクセスと操作

- **Cloud Console** や **クライアントライブラリ（Python, Java, Node.jsなど）** で操作可能
- **GQL (Google Query Language)** によるクエリも可能

例:
```sql
SELECT * FROM Person
```

## 整合性モデル

- **強整合性**：常に最新のデータを取得できる
- **結果整合性**：多少の遅延があっても最終的にデータが一致すればOK  
  ※グローバルな分散環境では結果整合性が有効なケースも多い

---

## 特徴まとめ

- スケーラブルでグローバル対応可能なNoSQLデータベース
- 柔軟なデータ構造と親子関係により複雑なモデルも表現可能
- Firestoreモードへの移行を念頭に設計を進めるのが推奨される

# 59. Firestoreの概要

## Firestoreとは？

Firestoreは、**Google Cloud**および**Firebase**で提供されている**スケーラブルなNoSQLデータベース**です。前身であるDatastoreの後継サービスで、モバイルアプリやWebアプリに最適化され、**グローバルスケール**での利用に対応しています。

- グローバル分散型・サーバーレス構造
- モバイル/Web向けに最適化
- Datastoreと異なるデータモデル（互換性なし）
- FirebaseおよびGCP両方から利用可能

---

## データモデルの特徴

Firestoreは**階層的な構造**を採用しています：

- **コレクション（Collection）**：ドキュメントを格納するコンテナ
- **ドキュメント（Document）**：基本的なデータ単位。フィールド（プロパティ）を持つ
- **フィールド（Field）**：ドキュメント内の各データ要素
- **ネスト構造**：コレクション内にさらにコレクションをネストできる

例：

---

## Datastoreとの違い

| 特徴               | Datastore                | Firestore                    |
|--------------------|--------------------------|------------------------------|
| モデル構造         | Namespace/Kind/Entity    | Collection/Document          |
| 階層構造           | あり（祖先キー）         | より柔軟なネスト可能         |
| 書き込み整合性     | 強整合性・結果整合性     | 選択可                        |
| モード             | Datastoreモード          | Firestoreモード（推奨）       |
| 今後のサポート     | 廃止予定                  | 主流（Firebaseと統合）       |

---

## 利用方法（コンソール）

Firestoreは以下の2つの方法で操作可能：

1. **Firebase Console**  
   - UIが分かりやすく、Webやモバイル向け機能と統合
2. **Google Cloud Console**  
   - GCPプロジェクトベースで設定・管理

> どちらからでも同じデータベースを編集・参照可能

---

## データ型の例

- `string`, `number`, `boolean`
- `map`, `array`, `timestamp`, `geo-point`
- 複雑なデータ構造にも対応

---

## 開発での利用例（Python）

Pythonなどのプログラミング言語からアクセス可能：

1. **秘密鍵を取得**（サービスアカウントから）
2. `firebase-admin` ライブラリをインストール
3. コレクション/ドキュメントの読み取りや書き込みを行う

```python
import firebase_admin
from firebase_admin import credentials, firestore

cred = credentials.Certificate("your-key.json")
firebase_admin.initialize_app(cred)

db = firestore.client()
users_ref = db.collection("users")
docs = users_ref.stream()

for doc in docs:
    print(doc.id, doc.to_dict())

特徴まとめ
FirestoreはDatastoreの後継として推奨されるNoSQLデータベース

グローバルスケール対応、サーバーレスで運用が容易

Firebaseを通じた利用でモバイル/Webアプリとの統合がスムーズ

柔軟な階層データ構造で、ネストされたデータにも対応

Datastoreとの互換性はなく、Firestoreを新規採用するのが望ましい

# 小テスト12: DatastoreとFirestore

## Datastoreとは？

- GCPが提供する**NoSQLドキュメントデータベース**
- 高スケーラビリティ・高可用性が特徴
- **強整合性**と**結果整合性**を選択可能
- データ構造は「Namespace → Kind → Entity → Property」
- Entityは「キー + プロパティ」で構成される
- クエリには**GQL（Google Query Language）**が使える

---

## Firestoreとは？

- **Datastoreの後継**としてGCPとFirebaseで提供
- **スケーラブルなNoSQLドキュメントDB**
- データ構造は「Collection → Document → Field」
- より柔軟な階層構造に対応（ネスト可能）
- Firebaseとの統合により**モバイル／Web開発に最適**
- 書き込み整合性は**強整合性**
- Datastoreとの互換性はない

---

## DatastoreとFirestoreの違い

| 項目                     | Datastore                     | Firestore（ネイティブモード）         |
|--------------------------|-------------------------------|---------------------------------------|
| 提供元                   | GCP                           | GCP & Firebase                        |
| データモデル             | Kind / Entity                 | Collection / Document                |
| 階層構造                 | 祖先パス（限定的）            | 柔軟なネスト構造                      |
| クエリ                   | GQL                           | クエリビルダー、Firebase SDK         |
| 書き込み整合性           | 強整合 or 結果整合             | 強整合性のみ                          |
| Firebase連携             | なし                           | あり（モバイル向け）                 |
| 今後のサポート           | 移行推奨（Firestoreモード）    | メインで提供                          |

---

## DatastoreからFirestoreへの移行

- GCPでは今後Firestore（ネイティブモード）への移行が推奨されている
- 既存のDatastoreプロジェクトは**Firestore Datastoreモード**で動作可能
- 新規開発やモバイルアプリでは**Firestoreネイティブモード**を選択するのが望ましい

---

## 補足：クエリの例

### Datastore（GQL）
```sql
SELECT * FROM Task WHERE done = false
```
