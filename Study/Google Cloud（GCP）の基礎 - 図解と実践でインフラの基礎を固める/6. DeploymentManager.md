# 44. Deployment Managerの概要

## 概要

- **Deployment Manager** は GCP リソースの構成とデプロイを管理する仕組み。
- **Infrastructure as Code (IaC)** の概念を実現：YAML構文ファイルを使って自動・効率的にリソースを作成。
- 対応リソース：- Compute Engine- Cloud Storage- Kubernetes Engine- BigQuery- Cloud SQL など

## IaCの利点

- オンプレミスのような手作業ではなく、**定義済みファイルによる自動構築**が可能。
- 一貫性があり、**ミスを防ぎながら高速な環境構築**が可能。

## 構文ファイルの種類

### 1. YAMLファイル

- GCPリソースを定義する基本フォーマット。
- 単体でリソース作成可能。

### 2. テンプレートの利用

同様の構文を繰り返す非効率を避けるための仕組み。

- **テンプレートの種類**- **Jinja2 テンプレート**：YAMLを生成するためのテンプレート言語。- **Pythonテンプレート**：Pythonスクリプトで構造を柔軟に定義可能。
- **テンプレート＋パラメータ**を使えば、同じ構造のリソースを複数作成可能。

## Terraformとの比較

- **Deployment Manager**：- GCP公式のIaCツール。- GCPリソースに特化。
- **Terraform**（HashiCorp製）：- **マルチクラウド対応**（AWS, Azure, GCP など）。- GCPでも利用可能。- 実際の現場では Terraform がよく使われる。

## この講義で扱う内容（全4ステップ）
1. **YAMLファイル**によるリソース定義
2. **Jinja2テンプレート**による効率化
3. **Pythonテンプレート**による柔軟な構成
4. **Terraform**によるデプロイ方法（Deployment Managerとは別ツール）

# 45. YAML によるデプロイ

このレクチャーでは、GCPの **Deployment Manager** を使用して、**YAMLファイルによるリソースのデプロイ**方法について解説します。

---

## ✅ YAMLによるデプロイの流れ

### 1. YAMLファイルの作成
- GCPのリソース（例：Compute Engine）の設定をYAML形式で記述
- 例: `deploy.yaml`
  ```yaml
  resources:
  - name: demo-vm-01
    type: compute.v1.instance
    properties:
      zone: asia-northeast1-a
      machineType: f1-micro
      disks:
      - ...
      networkInterfaces:
      - ...
### 2. Cloud Shellでファイル作成

- Cloud Shell のエディタから新規ファイルを作成し、YAMLを記述
    
- 保存後、Cloud Shell 内で確認可能（例: `ls` コマンド）
    

---

## 📦 デプロイの実行コマンド

`gcloud deployment-manager deployments create [デプロイ名] --config [YAMLファイル名]`

- 例:
    `gcloud deployment-manager deployments create demo-deploy --config deploy.yaml`
- 初回は `create` を使用
- 同じ名前で再実行するとエラーになるため、変更後は `update` を使用

## 🛠 デプロイの更新
```
gcloud deployment-manager deployments update demo-deploy --config deploy.yaml
```

## 🗑 デプロイの削除

### 一覧の確認

`gcloud deployment-manager deployments list`

### 削除コマンド

`gcloud deployment-manager deployments delete demo-deploy --async`

- `--async`: 非同期で処理（すぐに制御が返る）
    
- デフォルトでは **リソースごと削除**
    
- **定義だけを削除**したい場合はオプション指定が必要
    

---

## ⚠ 注意点

- `create`: 新規作成時のみ使用
    
- `update`: 既存デプロイメントの更新に使用
    
- YAMLファイルの記述が正確であることが重要
    
- 削除は `delete` コマンド、非同期で行うのが一般的
    

---

## 📝 このレクチャーで使用した技術
- Deployment Manager（GCP公式のIaCツール）
- YAML（リソース定義フォーマット）
- `gcloud` コマンド（CLIツール）

# 46. Jinjaテンプレートによるデプロイ

このレクチャーでは、**Jinjaテンプレートを利用したDeployment Managerによるデプロイ**方法を学びます。前回のYAMLファイルによる静的なデプロイと比較して、テンプレート化により **柔軟性と再利用性** が向上します。

---

## ✅ 使用する3つのファイル構成

| ファイル名 | 役割 |
|------------|------|
| `deploy.yaml` | デプロイメント構成ファイル |
| `parameters.jinja` | パラメータ設定ファイル |
| `vm-template.jinja` | VMリソースのテンプレートファイル（Jinja2構文） |

---

## 📦 YAMLファイル構造の違い

### 以前の構成（直接リソースを記述）

```yaml
resources:
- name: demo-vm
  type: compute.v1.instance
  properties:
```
### Jinjaテンプレートを利用した構成

yaml

`imports: - path: vm-template.jinja  resources: - name: vm01   type: vm-template.jinja   properties:     zone: asia-northeast1-a     machineType: f1-micro     vmName: vm-01`

---

## 🛠 テンプレートのメリット

- 複数のVMをテンプレート化して効率的に展開可能
    
- 定義の重複を排除でき、保守性が高まる
    
- パラメータを使って柔軟にインスタンス設定が可能
    

---

## 🚀 デプロイ手順

### デプロイ実行コマンド

`gcloud deployment-manager deployments create [デプロイ名] --config deploy.yaml`

例:

`gcloud deployment-manager deployments create vm-jinja-deploy --config deploy.yaml`

---

## 🧹 デプロイの削除

`gcloud deployment-manager deployments delete vm-jinja-deploy --async`

- `--async`: 非同期削除（コマンド実行後すぐ制御が戻る）
    
- ブラウザ上でリソースが削除中の状態になる
    

---

## 🔁 実行の流れまとめ

1. 3つのファイルをCloud Shell内に作成
2. YAMLファイル内でテンプレート（Jinja）を `imports:` で指定
3. `properties:` にパラメータを設定
4. `gcloud` コマンドでデプロイ・削除を実行
5. GCP上でVMが作成・削除されるのを確認

---

## 📝 このレクチャーで学んだこと

- Deployment Manager + Jinjaテンプレートを使ったインフラ定義
- 再利用可能なテンプレートによる構成管理
- `gcloud` コマンドによる作成・削除の流れ

# 47. Pythonテンプレートによるデプロイ

このレクチャーでは、**Pythonテンプレートを使ったDeployment Managerによるデプロイ方法**を解説します。  
Jinjaテンプレートと似ていますが、Pythonのコードを用いることでより柔軟で高度な処理が可能です。

---

## 全体構成とファイル構成

- **前回（Jinjaテンプレート）**: YAML＋Jinjaテンプレート＋パラメータファイルの3つに分離  
- **今回（Pythonテンプレート）**: YAML＋Pythonテンプレート＋パラメータファイルの3ファイル構成（拡張子が`.py`）

---

## Pythonテンプレートの特徴

- Pythonの関数`generate_config(context)`を使い、リソース定義をPythonの辞書（Dictionary）形式で作成  
- `context.properties`でパラメータ値を取得し、柔軟に文字列連結やデータ加工が可能  
- 例：ゾーンやマシンタイプ、イメージ名などを動的に指定  
- より複雑で高度なロジックをテンプレートに組み込める  

---

## ファイル例のイメージ

```python
def generate_config(context):
    resources = [{
        'name': context.properties['vmName'],
        'type': 'compute.v1.instance',
        'properties': {
            'zone': context.properties['zone'],
            'machineType': 'zones/' + context.properties['zone'] + '/machineTypes/' + context.properties['machineType'],
            'disks': [...],
            'networkInterfaces': [...],
        }
    }]
    return {'resources': resources}
```
## デプロイと削除の流れ

### デプロイ作成コマンド
`gcloud deployment-manager deployments create [デプロイ名] --config deploy.yaml`

### 削除コマンド
`gcloud deployment-manager deployments delete [デプロイ名]`

- 削除時は確認を求められるので「yes」と入力
- 削除処理はバックグラウンドで進み、完了まで時間がかかる場合あり

---

## ポイントまとめ
- Jinjaテンプレートと構造は似ているが、書き方はPythonコード
- Pythonの標準ライブラリやロジックを活用できるため、複雑な環境構築に向く
- Pythonに慣れている場合はPythonテンプレートのほうが柔軟で便利

---

## まとめ
- Pythonテンプレートを使ったDeployment Managerは、コードで柔軟にリソースを定義可能
- 3つのファイル（デプロイ設定YAML、パラメータファイル、Pythonテンプレート）で構成
- `gcloud`コマンドで作成・削除を行い、GCPのリソースを自動で管理できる


# 48. Terraformによるデプロイ

このレクチャーでは、**Terraformを使ったGCPリソースのデプロイ**方法を紹介します。

---

## Terraformとは

- **Terraform**はサードパーティ製のインフラストラクチャー構築ツール  
- 複数のクラウド（AWS、GCP、Azureなど）に対応可能なインフラストラクチャー as コードの代表的ツール  
- GCPのクラウドシェルにはTerraformがあらかじめインストールされているため、すぐに利用可能  
- 現場ではDeployment ManagerよりTerraformの利用が多いケースも多い

---

## Terraformの特徴と使い方

- **記述形式はDeployment ManagerのYAMLとは異なり、Terraform独自のHCL言語を使用**  
- 例としてVM作成のための`main.tf`ファイルに、マシンタイプやゾーン、ディスクなどを定義  
- 主なTerraformコマンド：
  - `terraform init`：初期化（モジュールやプロバイダーのダウンロード）
  - `terraform plan`：変更予定のプランを表示（プレビュー）
  - `terraform apply`：実際にリソースを作成（適用）

---

## 実際の流れ

1. `main.tf`ファイルを作成しリソース定義  
2. ターミナルで`terraform init`を実行して初期化  
3. `terraform plan`で作成内容を確認  
4. `terraform apply`で実際にGCP上にリソースを作成  
5. GCPコンソールでVMが作成されたことを確認可能

---

## まとめ

- Terraformは複数クラウドに対応し、強力かつ柔軟なインフラ管理が可能  
- GCPではDeployment Managerと併用し、用途や好みに応じて使い分けができる  
- YAMLが得意ならDeployment ManagerのJinjaテンプレート、Pythonが得意ならPythonテンプレート  
- Terraformはより広範囲なクラウドリソース管理やチームでの利用に適している  

---

# 小テスト6: DeploymentManager

---

## 問題例（要約）

1. **Deployment Managerとは何か？**  
   GCPのリソースをコード（YAMLやテンプレート）で自動的に作成・管理する仕組み。

2. **インフラストラクチャー as コード（IaC）の利点は？**  
   手動作業のミス削減、迅速かつ効率的な環境構築、再現性の確保。

3. **Deployment Managerで利用できるテンプレートの種類は？**  
   - Jinjaテンプレート（YAMLと組み合わせて利用）  
   - Pythonテンプレート（より柔軟なスクリプト記述が可能）

4. **Deployment Managerの基本的な操作コマンドは？**  
   - 作成：`gcloud deployment-manager deployments create [NAME] --config [CONFIG_FILE]`  
   - 更新：`gcloud deployment-manager deployments update [NAME] --config [CONFIG_FILE]`  
   - 削除：`gcloud deployment-manager deployments delete [NAME]`

5. **Terraformとの違いは？**  
   Deployment ManagerはGCP専用、Terraformはマルチクラウド対応のサードパーティツール。

---

## まとめ

- Deployment ManagerはGCPリソースのコード管理を効率化  
- YAMLファイルやテンプレートを使い、複数のリソースをまとめて管理可能  
- 操作はコマンドラインで簡単に実行できる  
- Terraformとの使い分けを意識することが重要  

---
