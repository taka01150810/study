# 77. Pub/Subの概要

## Pub/Subとは
- アプリケーション間でメッセージをやり取りするための安全でスケーラブルなメッセージングシステム。
- イベントの取り込みやストリーミング分析、クラウドサービス連携に利用される。

## 主な特徴
- **順序指定**：メッセージを順番通りに送信・取得可能。
- **最低一回配信保証**：メッセージの消失を防ぎ、最低1回は必ず配信される。
- **アクセス制御と暗号化**：安全なメッセージ送受信を実現。

## モード
- **プルモード**：サブスクライバー（受信側）が自分でメッセージを取得しに行く。
- **プッシュモード**：サブスクライバーがHTTP(S)エンドポイントを持ち、Pub/Subから直接メッセージを送信。

## 構成要素
- **トピック**：メッセージ送信先のチャネル。
- **サブスクリプション**：トピックからメッセージを受信するための登録。

## メッセージ配信の例
- 複数のサブスクライバーが同じトピックのメッセージを受信可能。

## 利用料金
- 1ヶ月あたり10GBまでは無料枠。
- 10GB超過後は1TBあたり約40ドル（約5,000円）。

## Pub/Sub Lite
- リージョン単位での低コスト版。
- コストパフォーマンス重視で範囲限定の利用に適している。

## クライアントライブラリ
- Python、C++、C#、Go、Java、Node.js、PHP、Rubyなど多様な言語対応。

## ユースケース
- ストリーミングデータの取り込み・分析基盤へのデータ送信（BigQuery、Dataflowなど）
- IoTやWebアプリ、モバイルアプリからのデータ受信
- 非同期マイクロサービス間のメッセージ連携
- セキュアで拡張性のあるイベントドリブンアーキテクチャ構築

## その他の機能
- フィルタリングによるメッセージ選別
- デッドレタートピックで配信失敗メッセージのデバッグ
- At-least-once 配信モードで確実なメッセージ伝達

---

次回はPub/Subの具体的な構築方法を解説します。

# 78. パブリッシャーとサブスクライバーの作成

## 概要
- Pub/Subの基本構造である**トピック**と**サブスクリプション**を実際に作成していく。
- トピックはメッセージを送信するチャネル。
- サブスクリプションはトピックからメッセージを受信する仕組み。

## 手順とポイント
- GCPのメニューの分析カテゴリからPub/Subを選択。
- まずはAPIを有効化する必要がある（ライト版利用時も同様）。
- トピック作成時にメッセージのスキーマ（形式）を定義可能（任意）。
- メッセージ保持期間や暗号化キー設定（カスタム鍵）などのオプションも設定できる。

## クラウドファンクションとの連携
- Pub/Subのメッセージが書き込まれた際にクラウドファンクションをトリガー可能。
- クラウドファンクションはメッセージを受信し、内容を処理・出力できる。

## サブスクリプション作成
- トピックに紐づけてサブスクリプションを作成。
- サブスクリプションのタイプはプル型（受信者がメッセージを取りに行く）かプッシュ型（Pub/Subからエンドポイントへ送信）を選択可能。
- プッシュ型の場合、エンドポイントURL（クラウドファンクション、App Engine、オンプレミス等）を指定。

## その他サブスクリプション設定
- メッセージの保持期間や有効期限の設定。
- フィルター機能で受信するメッセージの選別が可能。
- Exactly-once配信を有効にして、重複のない確実な配信も設定可能。
- 順序指定（Order Key）やデッドレタリング（配信失敗メッセージの再送処理）なども設定可能。
- 再試行ポリシー（指数バックオフ等）もカスタマイズできる。

## メッセージの送受信テスト
- 作成したトピックに「HELLO」などのメッセージをパブリッシュ可能。
- サブスクリプションは複数作成でき、プル型とプッシュ型で同じメッセージを受信できる。
- プル型サブスクライバーは手動で「プル」操作を行いメッセージを受信。
- プッシュ型はクラウドファンクションが自動でメッセージを受信し処理。

## まとめ
- トピック1つに複数のサブスクリプションを紐づけて、同じメッセージを複数の受信者へ届けられる。
- 次回はアプリケーションプログラム側でのメッセージ受信処理を解説予定。

---

# 79. PythonプログラムによるPub/Subの実装

## 概要
- 前回作成したトピックとサブスクリプションを使い、PythonでPub/Subのメッセージ送受信プログラムを書く。
- 手動でのメッセージ送受信から、プログラムによる自動化へ。

## 準備
- GCPでサービスアカウントを作成し、Pub/Subの管理者ロールを付与。
- サービスアカウントの鍵（JSONファイル）をダウンロードし、作業ディレクトリに配置。
- 環境変数 `GOOGLE_APPLICATION_CREDENTIALS` に鍵のパスを設定。
- Python用のPub/Subクライアントライブラリを`pip`でインストール。

## パブリッシャープログラムの構成
- ライブラリをインポート。
- プロジェクトIDとトピックIDを設定。
- Pub/Subクライアントのパブリッシャーオブジェクトを作成。
- トピックの完全パスを生成。
- メッセージをエンコードし、トピックに複数回パブリッシュ。
- 完了メッセージをコンソールに表示。

## サブスクライバープログラムの構成
- プロジェクトIDとサブスクリプションIDを設定。
- Pub/Subクライアントのサブスクライバーオブジェクトを作成。
- サブスクリプションからメッセージを受信し、内容をデコードして表示。
- 複数メッセージの受信が可能。

## 実行と確認
- パブリッシャープログラムを実行すると、トピックにメッセージが送信される。
- サブスクライバープログラムを実行すると、溜まっているメッセージを取得して表示。
- コンソールでもプル操作によりメッセージ受信が可能。
- プッシュ型サブスクリプションではクラウドファンクションがメッセージを受信し、ログに出力される。

## 補足
- クレデンシャルの設定ミスによるエラーが発生することがあるので環境変数の設定を確認すること。
- メッセージ送受信はオンプレミスのアプリケーションやクラウドファンクションなど様々な形態で実装可能。
- シンプルなPythonコードでPub/Subの基本的なメッセージ送受信の仕組みを体験できる。

---

# 小テスト19: Pub/Subの概要

- Pub/SubはGoogle Cloudのメッセージングサービスで、非同期にメッセージを送受信できる仕組み。
- 主な構成要素は「トピック」と「サブスクリプション」。
  - **トピック**：メッセージの送信先。
  - **サブスクリプション**：トピックからメッセージを受信するための登録。
- メッセージ配信はプル型（受信側が取得）とプッシュ型（送信側が指定エンドポイントへ送信）がある。
- メッセージの順序制御や再配信制御、デッドレター機能などの高度な設定が可能。
- スケーラブルで耐障害性が高く、イベントドリブンやストリーミング処理に適している。

---
