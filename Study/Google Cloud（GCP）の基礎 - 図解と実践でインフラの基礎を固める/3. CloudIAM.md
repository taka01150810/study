# 31. IAMの仕組み

## IAMとは
- IAM（Identity and Access Management）は、「誰がどのリソースに対してどんなアクセス権を持つか」を定義し、アクセス制御を管理する仕組み。
- 「誰が」はプリンシパル（ユーザーやサービスアカウントなど）を指す。
- 「何に対して」はGCPのリソース（クラウドストレージ、コンピュートエンジン、組織、フォルダ、プロジェクトなど）。
- 「どのようなアクセス権（ロール）」を持つかを設定する。

## 主要な概念
### プリンシパル
- アクセスを行う主体。
- 例：Googleアカウント（人間用）、サービスアカウント（アプリケーション用）、Googleグループ、Cloud Identityなど。

### ロール（役割）
- 複数の権限（パーミッション）をまとめた集合。
- 例：編集者ロール、閲覧者ロール、ログビューアーロールなど。
- プリンシパルにロールを割り当てることで、そのロールに含まれるすべての権限を付与する。

### ポリシー
- プリンシパルに対してロールをバインド（割り当て）する設定の集合。
- ポリシーがアクセス権の許可・拒否を決定する。

## IAMの動作イメージ
1. ユーザー（プリンシパル）が認証される。
2. ユーザーがリソースにアクセスしようとすると、IAMポリシーで権限チェックが行われる。
3. ポリシーに基づき、アクセス権があれば許可される。

## ポリシーとバインディング
- バインディングとは「プリンシパルにロールを割り当てる」行為。
- ポリシーは複数のバインディングの集合で構成される。

## 画面での確認
- GCPコンソールの「IAMと管理」→「IAM」画面でプリンシパルと割り当てられているロールを確認可能。
- ロール視点でどのプリンシパルが権限を持っているかも確認できる。
- ロールの詳細では含まれる権限一覧も確認できる。

---

IAMは「誰が」「どのリソースに」「どのロール（権限）を持つか」をポリシーで定義し、GCPリソースへのアクセス制御を行う重要な仕組みです。

# 32. プリンシパル

## プリンシパルとは
- IAMポリシーで「誰が」にあたる部分。
- GCPリソースへのアクセス権を持つ主体のこと。

## プリンシパルの種類
1. **Googleアカウント**  
   - 個人のGoogleアカウント。誰でも簡単に作成可能。
   - これを使ってリソースへのアクセス権を付与できる。

2. **サービスアカウント**  
   - アプリケーションやサービスが使うアカウント。
   - 例：Compute EngineのVMに紐づけて、別のリソース（例：Cloud Storage）へアクセス権を与える。

3. **Googleグループ**  
   - 複数のGoogleアカウントやサービスアカウントをまとめた集合。
   - チームや部署単位でまとめて権限を管理可能。

4. **Google Workspaceアカウント**  
   - 企業や学校などの組織用Googleアカウント。
   - 独自ドメインを利用してユーザー管理を行う。

5. **Cloud Identityドメイン**  
   - Googleが提供するクラウド版ディレクトリサービス。
   - Active Directoryなど外部ディレクトリと連携可能で、一元的にユーザー・グループ・デバイスを管理。

6. **認証済み全ユーザー（allAuthenticatedUsers）**  
   - Googleアカウントなどで認証されたすべてのユーザー。

7. **全ユーザー（allUsers）**  
   - インターネット上の匿名ユーザーすべて（認証なし）。

## 匿名ユーザーへのアクセス許可
- 例：Cloud Storageのバケットに「allUsers」を追加し、閲覧権限を付与すると誰でも匿名でアクセス可能になる。
- 公開リソースを作る場合に使うが、セキュリティには注意が必要。

## プリンシパル活用のプラクティス
- 管理者1人よりも**Googleグループ**で管理チームを作るのが望ましい。
- メンバーの入れ替えや管理をグループ単位で行い、アクセス権の管理を効率化できる。
- 例：田中さん・鈴木さんなど複数名で管理チームを作成し、権限を付与。

---

プリンシパルはGCPリソースにアクセスする主体で、状況に応じて7種類のプリンシパルを使い分けてアクセス制御を行います。

# 33. ロール

## ロールとは
- 権限（パーミッション）のコレクション（集合）。
- 個別の権限をプリンシパルに直接付与するのではなく、ロール単位で付与する。

## ロールの種類（3種類）
1. **基本ロール（Basic Roles）**
   - 例：オーナー、編集者、閲覧者、参照者など。
   - ざっくりと広範囲の権限をまとめている。
   - 何千もの権限が含まれることもあり、本番環境での使用は推奨されない。
   - 検証やテスト環境での利用が多い。

2. **事前定義ロール（Predefined Roles）**
   - GCPがサービス別に細かく用意しているロール。
   - 例：クラウドストレージ閲覧者や編集者など、特定サービスにフォーカスした権限セット。
   - スコープが限定されており、本番環境での利用に推奨される。

3. **カスタムロール（Custom Roles）**
   - ユーザーがニーズに合わせて独自に権限を組み合わせて作成可能。
   - 管理は手間がかかるが、最小権限の原則に沿った権限付与ができる。
   - 削除しても7〜14日間は復元可能。

## ロールの管理と操作
- GCPコンソールの「IAM と管理」→「ロール」から閲覧・作成・編集が可能。
- 作成時にロール名、説明、リリース段階（アルファ・ベータ・GA）を設定。
- 権限は数千件から選択可能で、フィルター機能も利用できる。
- ロールのステータス変更（有効・無効）、編集、削除なども可能。

## ベストプラクティス
- **最小権限の原則**を遵守し、基本ロールではなく事前定義ロールやカスタムロールを利用する。
- 本番環境での権限管理はより細かく限定されたロールを推奨。

---

ロールはGCPアクセス権限管理の基本単位であり、権限の集合体として「誰にどの権限を付与するか」を効率的に管理します。

# 34. カスタムロール

## カスタムロールとは
- ユーザーがニーズに合わせて権限のコレクションを作成できるロール。
- 作成時にはリリース段階（ALPHA、BETA、GAなど）やサポートレベルの確認が重要。

## サポートレベルの種類
1. **サポート（Supported）**
   - カスタムロールで完全にサポートされる権限。
   - 本番環境でも安心して使用可能。

2. **テスティング（Testing）**
   - テスト段階の権限。
   - カスタムロールに含められるが、予期せぬ動作が起こる可能性あり。
   - 本番環境での使用は推奨されない。

3. **非サポート（Not Supported）**
   - カスタムロールに含められない権限。
   - 追加も不可。

## リリース段階の意味
- **ALPHA**
  - 開発・テスト中の段階。
  - 未公開の権限を含むこともあるため、利用には注意が必要。

- **BETA**
  - 限定的にテストされている段階。
  - 一般提供前の段階で、本番環境での利用は慎重に。

- **GA（General Availability）**
  - 一般提供版。
  - 広範囲にテストされており、本番環境での使用が推奨される。

- **無効（Disabled）**
  - カスタムロールを無効化可能。

## カスタムロール作成時の注意点
- サポートレベルを考慮して権限を追加する。
- テスト段階の権限を含む場合はリリース段階をALPHAやBETAに設定し、利用者に状態を伝える。
- 非サポート権限は追加不可。

## 操作イメージ（GCPコンソール）
- 「IAM と管理」→「ロール」からカスタムロールの作成。
- 名前、説明、リリース段階を設定。
- 権限を検索・追加する際、サポートレベルに応じて追加可否が判別できる。
- 作成後はステータスの変更や権限の編集も可能。

## 補足：ソフトウェアのリリース段階について
- **ALPHA**：開発初期、限定的テスト。
- **BETA**：広範囲でのテスト、6ヶ月程度でGAへ移行が多い。
- **GA**：製品版、正式サポート。

---

カスタムロールは細かい権限管理を可能にする一方、権限のサポートレベルやリリース段階に注意して設定し、適切に運用することが重要です。

# 35. ポリシー

## ポリシーの概要
- ポリシーはプリンシパル（メンバー）にロールを割り当てた「バインディング」の集合体。
- これをリソース階層（組織、フォルダー、プロジェクトなど）に設定する。

## ポリシーの構造
- ポリシーはJSON形式で表現されるテキストデータ。
- **ロール**は「サービス名.ロール名」という形式で表される（例：`roles/storage.objectViewer`）。
- **メンバー（プリンシパル）**は種類ごとに接頭辞が付く。
  - ユーザー: `user:`
  - サービスアカウント: `serviceAccount:`
  - グループ: `group:`
  - ドメイン: `domain:`
- バインディングは「ロール」と「メンバー」のペアで構成される。

## APIによる操作
- ポリシーを操作するAPIが用意されている。
  - `GetIamPolicy`: ポリシーを取得
  - `SetIamPolicy`: ポリシーを設定
  - `TestIamPermissions`: 指定権限の有無を確認
- これらはgcloudコマンドやクラウドシェル、その他APIクライアントから利用可能。

## 実際の取得例
- クラウドシェルで`GetIamPolicy`を実行すると、メンバーと割り当てられたロールの構造がJSON風に取得できる。
- 例えば特定ユーザーがどのロールを持っているか、どんな権限が含まれているかが分かる。

## ポリシーアナライザー機能
- ポリシーが増えると管理が複雑になるため、分析用ツール「ポリシーアナライザー」がある。
- 例: 「オーナーや編集者ロールを持つプリンシパルは誰か？」などのクエリを実行できる。
- プロジェクトやプリンシパル、権限などを指定して詳細検索が可能。

---

ポリシーはロールとメンバーの組み合わせ（バインディング）で成り立っており、JSON形式で管理される。  
APIやツールを使って設定・取得・分析ができる仕組みがあることを理解するのがポイントです。

# 36. ポリシーの継承

## ポリシーの継承の概要
- IAMポリシーはリソース階層の任意のレベル（組織、フォルダー、プロジェクト、リソース）で設定可能。
- 上位リソースに設定されたポリシーは下位リソースに継承される（親から子へ継承される水平方向の性質）。
- 最終的にリソースに適用されるポリシーは「そのリソースに設定されたポリシー」と「上位から継承されたポリシー」の和集合。

## リソース階層の例
- 組織（Organization）
  - フォルダー（例: 営業チーム、エンジニアリングチーム、人事部）
    - プロジェクト（本番環境用、開発環境用、テスト環境用など）
      - 具体的なリソース（クラウドストレージ、App Engine、Compute Engine など）

## 継承の具体例（Compute Engineを例に）
- 例として「ボブさん」と「アリスさん」がいる。
  - ボブさん：組織全体のネットワーク管理者（`Compute Network Admin`ロール付与）
  - アリスさん：特定プロジェクトの開発チームメンバー（`Compute Instance Admin`ロール付与）

### ボブさんの権限範囲
- 組織レベルでネットワーク管理者ロールが付与されているため、
- 組織以下のすべてのフォルダー・プロジェクト・リソースにその権限が継承される。
- ネットワーク関連のリソースの管理が可能。

### アリスさんの権限範囲
- 特定のプロジェクトにのみインスタンス管理者ロールが付与されているため、
- そのプロジェクトとその下のリソースにのみ権限が適用される。
- ネットワーク管理の権限は持たず、インスタンスの操作のみ可能。

## ポリシー継承の重要ポイント
- ポリシーは階層的に継承され、上位リソースの設定が下位に影響する。
- これにより、組織全体の一括管理や、細かい権限設定が可能になる。
- 役割と権限の範囲を明確に理解することが重要。

---

ポリシーの継承はIAMの基本的かつ重要な性質であり、リソース階層の上位から下位へロール権限が引き継がれることを覚えておきましょう。

# 37. IAM_APIの整合性レベル

## IAM API整合性モデルの概要
- IAM APIはサービスアカウントの作成や権限付与などの操作を管理するAPI。
- このAPIを通じて管理される「データ」とは、IAMの管理情報（例：サービスアカウントに付与された権限など）を指し、クラウドストレージなどのサービス内のデータとは異なる。

## 整合性の種類
### 結果整合性 (Eventual Consistency)
- IAM APIからデータを読み取る際は結果整合性に基づく。
- 例えば、13:00に「サービスアカウントに読み取り権限を付与した」としても、
  - すぐにAPIで読み取ると古い情報が返ることがある（反映に数秒〜数分かかる）。
  - そのため、直後にアクセス権のチェックをすると「権限がない」と判断される場合がある。
- しばらく待ってから再度チェックすると、正しく権限が反映されアクセスが可能になる。

### 逐次整合性 (Sequential Consistency)
- IAM APIに対しての書き込み操作（権限の追加・削除など）は逐次整合性に基づく。
- 複数のAPI呼び出しがあった場合、APIが受け取った順序で処理される。
- 例えば、権限の追加→削除→追加の順にリクエストがあったら、その順で処理される。

## アプリケーションへの推奨対応
- アプリケーションがIAMの権限を利用してクラウドリソースにアクセスする際、
  - 権限付与直後にアクセスを試みて失敗（NG）が返ってもすぐに諦めず、再試行することが推奨される。
- 推奨される再試行方法は「切り捨て型指数バックオフ（Truncated Exponential Backoff）」：
  - リトライを繰り返しつつ、試行間隔を徐々に長くしていくアルゴリズム。
  - これにより最終的に権限変更が反映されてアクセス成功する可能性が高まる。

## 用語補足
- **結果整合性**：データ書き込み後、しばらく時間が経たないと反映されない性質。
- **切り捨て型指数バックオフ**：リトライ時の待機時間を指数関数的に増やしながら最大時間まで繰り返すアルゴリズム。

---

IAM APIの整合性モデルは、権限付与や変更の反映にタイムラグが生じるため、アプリケーション側で適切な再試行処理を設けることが重要です。

小テスト3: IAM