# 12. Compute Engineの概要

---

## 概要
- Compute EngineはGoogleのインフラで動く、安全でカスタマイズ可能な仮想マシンサービス。
- LinuxやWindowsのOSを選択して仮想マシン（VM）を作成可能。
- IaaS（Infrastructure as a Service）モデルで、OS以上のレイヤーを自由にカスタマイズできる。
- ミドルウェアや開発言語ランタイムを入れてアプリケーションを構築可能。
- カスタマイズ範囲の管理はユーザーの責任。

## マシンタイプ
- 事前定義されたタイプ（計算最適化型、メモリ最適化型など）を選択可能。
- カスタムマシンタイプもあり、CPUコア数やメモリサイズを自由に設定可能。
- OSは多数のLinuxディストリビューションやWindowsサーバーが選択可能。
- クライアントOS（Windows10など）は基本的に選べないがカスタムイメージで対応可。

## 料金
- 最低料金は月額約700円から利用可能。
- 使用時間に応じて秒単位で課金（最初の1分は分単位）。
- 割引制度あり：
  - 確約利用割引（1年・3年契約で2〜5割引、キャンセル不可）
  - 継続利用割引（一定稼働時間を超えると最大3割割引、自動適用）

## プリエンプティブVM
- リソースが必要な時に強制的に停止される仮想マシン。
- SLAなし、最大8割の大幅割引あり。
- フォールトトレラント設計のアプリや大量ジョブ処理に適している。

## 利用シーン例
- オンプレの仮想・物理マシンのクラウド移行（リフト＆シフト）。
- 急な開発用仮想マシンの追加。
- 特殊ドライバーやソフトウェアが必要なケース。
- 幅広い用途に対応可能な高い汎用性を持つ。

---

## まとめ
Compute Engineは柔軟でカスタマイズ性の高い仮想マシンサービスで、低価格から大規模利用まで対応可能。  
利用用途に合わせたマシンタイプや割引制度を活用してコスト最適化ができる。  
プリエンプティブVMを使えばコストを大幅に下げつつも、フォールトトレラントな設計で効率よくリソース活用が可能。

# 13. Linuxマシンの構築と接続

---

## 概要
- GCPコンソールで「VMインスタンス」を検索し、仮想マシンを作成する。
- インスタンス作成画面で以下を設定：
  - 名前
  - リージョン（例：東京リージョン。価格やレスポンスに影響）
  - ゾーン（リージョン内の配置場所）
  - マシンタイプ（事前定義されたタイプまたはカスタム構成が可能）
    - 例：e2-micro（約9ドル/月）、スモール（約17ドル/月）
    - CPUコア数やメモリサイズを自由にカスタム可能（GCPの特徴）
  - ブートディスク（OSイメージ）
    - Debian、Ubuntu、CentOS、Windows Serverなどから選択可能
    - 今回はUbuntu 18を選択

## その他設定
- ファイアウォールでHTTP/HTTPS通信を許可可能（ウェブサーバー向け）
- 削除保護や可用性ポリシー（プリエンプティブVMの設定）も可能
  - プリエンプティブを有効にすると約3ドル/月の安価利用も可能

## 作成・接続
- 作成後、約30秒〜1分でVMが起動
- 外部IPが割り当てられ、SSHボタンで簡単に接続可能
- SSH接続後、Linuxコマンド（例：ls）で操作できる
- 選んだリージョンによって接続速度やレスポンスが変わる（東京リージョンは日本から高速）

## 利用時のポイント
- 使わない時は停止推奨（停止中はコンピュート料金がかからない）
- 必要に応じてインスタンス削除も可能

---

## まとめ
GCPのVMインスタンスはGUIから簡単に作成・接続でき、CPUやメモリのカスタムも可能。  
リージョン選択でパフォーマンスやコストを調整でき、プリエンプティブVMでさらにコスト削減もできる。  
Linuxマシンの構築から運用まで柔軟に対応可能なサービス。

# 14. OS LoginによるSSH接続

---

## 概要
- LinuxインスタンスへのSSH接続方法の一つに「OSログイン」がある。
- 従来はメタデータ内のSSH鍵を使って認証していたが、これはセキュリティリスクがある。
- OSログインでは、GCPのIAMロールを利用し、アクセス権限を細かく制御できる仕組み。
- これにより、VMインスタンスのメタデータにSSH鍵を管理する必要がなくなるため、セキュリティ向上に繋がる。

## OSログインの特徴
- インスタンス単位またはプロジェクト単位で有効化可能。
- Linuxのみ対応、Windowsは非対応。
- 無料で利用可能。

## アクセス制御の仕組み
- ユーザーやグループに「コンピュートOSログイン」ロールや「サービスアカウントユーザー」ロールを付与してアクセス権を管理。
- オーナー権限や編集権限を持つユーザーは広範囲にアクセス可能。
- 参照権限だけのユーザーはアクセス不可。
- インスタンス側でもOSログイン有効設定が必要。

## 実演内容
1. 2台のVMを作成（OSログインONとOFF）
2. オーナーユーザーはどちらもSSH接続可能。
3. 編集者権限のユーザーを追加し、SSH接続を試す。
4. OSログインONのインスタンスにはアクセス可能、OFFのインスタンスにはアクセス不可。
5. 参照権限のみのユーザーはアクセス不可。
6. 「コンピュートOSログイン」と「サービスアカウントユーザー」ロールを追加付与したユーザーはOSログインONのインスタンスにアクセス可能。

## まとめ
- OSログインを使うと、IAMの役割ベースアクセス制御（RBAC）でSSHアクセスを安全に管理できる。
- メタデータでSSH鍵を管理しなくてよくなり、セキュリティリスクを低減できる。
- インスタンス毎にアクセス制御を細かく設定可能で柔軟性が高い。


# 15. Windowsマシンの構築と接続

---

## 概要
- WindowsマシンもGCPで簡単に作成可能。
- Linuxマシンと構築手順はほぼ同じだが、WindowsはOSライセンス料が発生する。
- 接続方法はLinuxのSSHに対し、Windowsはリモートデスクトップ（RDP）を使用。

## 料金について
- WindowsはOSライセンス料金が加算されるため、Linuxより高価。
- 例：小規模マシンで約62ドル/月、サイズやリージョンによって変動。
- Windows専用のイメージ選択時にはOS使用料が別途発生。

## 構築手順
1. GCPコンソールで「VMインスタンス」を開き、「インスタンスの作成」。
2. 名前、リージョンを選択。
3. マシンタイプを選択（例：micro）。
4. ブートディスクで「Windowsサーバー」を選択し、バージョンを指定。
5. ファイアウォールや削除保護、プリエンプティブの設定を行う（任意）。
6. 「作成」をクリックしインスタンスを作成。

## 接続方法
- 作成後、Windowsパスワードを設定し発行。
- RDP接続用ファイル（.rdp）をダウンロード。
- ダウンロードしたファイルを開き、設定したユーザー名とパスワードでリモートデスクトップ接続を行う。
- 接続までに5〜10分ほど待つ場合がある。

## 注意点
- フリートライアルアカウントではWindowsマシン作成できない場合があるため、通常アカウントまたは別プロジェクトで作成する必要がある。
- 接続完了まで時間がかかる場合がある。

---
# 16. 偶発的なVM削除の防止

---

## 概要
- VMインスタンスの誤削除を防止するための機能。
- 重要なサーバー（例：データベースサーバーやライセンスマネージャー）を誤って削除し、システム全体に影響が出ることを防ぐ。

## 権限について
- VM削除には「コンピュートインスタンスの作成・削除」権限が必要。
- オーナーロールはこれらの権限を持っている。
- デフォルトではこの削除防止機能はオフ。

## 対応OS
- Linux、Windows両方で設定可能。

## 設定方法
1. VMインスタンス作成時、管理タブを開く。
2. 「削除からの保護を有効化」にチェックを入れる。
3. インスタンス作成後、この設定により削除操作がブロックされる。

## 削除したい場合
1. 対象のVMの編集画面を開く。
2. 「削除からの保護」のチェックを外す。
3. 保存を忘れずに行う。
4. その後、削除操作が可能になる。

---


# 17. 永続ディスク

---

## 永続ディスクとは
- 長期的なネットワークストレージ。
- インスタンス（VM）からネットワーク越しにアクセス可能。
- データは複数の物理ディスクに分散保存され、冗長性とパフォーマンスを確保。
- VMインスタンスとは独立して存在し、VMを削除しても永続ディスクは残せる。
- 新しいVMに再アタッチしてデータ再利用も可能。
- ライフサイクルはVMと独立して設定できる。

## パフォーマンスとサイズ
- ディスクサイズを大きくするとパフォーマンスも向上。
- 追加の永続ディスクを増やして容量や性能を調整可能。

## 永続ディスクの種類（4タイプ）
1. **標準永続ディスク（HDD）**  
   - 磁気ディスク、コスト重視。
2. **バランス永続ディスク（SSD）**  
   - コストと性能のバランス良好、汎用的なエンタープライズ用途向け。
3. **SSD永続ディスク**  
   - 高パフォーマンス重視、IOPS効率が高い。  
   - クリティカルな業務向け。
4. **エクストリーム永続ディスク**  
   - ランダムアクセスとバルクスループット両対応。  
   - SAP HANA等のハイエンドDB向け。

## 永続ディスクの設定箇所
- VM作成時の「ブートディスク」  
- 追加ディスクとして「データディスク」

## ローカルSSD
- VMインスタンスのホストサーバーに物理的に近い場所に配置。
- ネットワーク越しではなく物理的に接続されるため、高スループット・低レイテンシ。
- ライフサイクルはVMと同じ（VM削除時にローカルSSDも削除される）。
- サイズは375GB/枚、最大24枚接続可能（合計約9TB）。
- 高パフォーマンスだが冗長化されず、障害時にデータ消失リスクあり。  
  → 重要データの保存には不向き。

---

## まとめ
- 永続ディスクはVMのストレージとして独立した長期保存が可能なネットワーク接続ストレージ。
- 性能やコストに応じて4種類の永続ディスクを選択可能。
- 高性能が必要ならローカルSSDも利用可能だが、耐久性は低いため用途を選ぶ必要がある。
# 18. ストレージオプション

---

## コンピュートエンジンのストレージ選択肢（5つ）

1. **ゾーン永続ディスク**  
   - 最も標準的なブロックストレージ。  
   - 1つのゾーン内に配置。効率的で信頼性高い。  
   - ゾーン障害時は利用不可になるリスクあり。

2. **リージョン永続ディスク**  
   - 複数ゾーン（通常2ゾーン）にまたがりデータを複製。  
   - ゾーン障害時も可用性が高い。  
   - コストはゾーン永続ディスクの約2倍。

3. **ローカルSSD**  
   - コンピュートエンジンと同じ物理サーバーに配置。  
   - 高パフォーマンス（高スループット・低レイテンシ）。  
   - VMとライフサイクルが同じで、VM削除時にデータも消失。  
   - 冗長化なし、耐久性・可用性は低い。

4. **クラウドストレージ（バケット）**  
   - オブジェクトストレージサービス。  
   - グローバル利用可能、スケーラブル。  
   - 低レイテンシーが必要なアプリには不向き。

5. **ファイルストア（ファイル共有サービス）**  
   - ファイル共有用の別サービス。  
   - ゾーン単位またはリージョン単位で利用可能。  
   - 可用性は高いがコストは高め（ゾーン利用で最低2万円程度～）。

---

## 各ストレージの特徴まとめ
- **ゾーン永続ディスク**は標準で迷ったらこれを選ぶ。
- **リージョン永続ディスク**は高可用性が必要な場合に選択。
- **ローカルSSD**は高速処理向けだが、耐久性は低いので注意。
- **クラウドストレージバケット**はファイルやオブジェクト保存に適する。
- **ファイルストア**は共有ファイル用、高性能だがコスト高。

---

## 実際の設定例
- 永続ディスクはVM作成時に「ディスクを追加」で種類とサイズを設定。
- ローカルSSDはマシンタイプ制限あり（N1シリーズ推奨）。
- リージョン永続ディスクは専用画面からゾーンとレプリカゾーンを指定して作成し、VMにアタッチ可能。
- クラウドストレージはバケット作成後、サービスとして利用。
- ファイルストアは別途インスタンスを作成し、マウントして使用。

---

## 注意点
- パフォーマンス向上と耐久性・可用性はトレードオフの関係にある。
- コスト面も考慮し用途に応じて最適なストレージを選択することが重要。

# 19. ブロックストレージのパフォーマンス

---

## 永続ディスクのパフォーマンス概要
- 永続ディスクはネットワーク越しのストレージのため、物理ディスクやローカルSSDと比べてレイテンシーが大きい。  
- 永続ディスクには4つのタイプがあり（標準、バランスSSD、SSD、エクストリームなど）、タイプとサイズでパフォーマンスが変わる。  
- ディスクサイズを大きくすると、物理的にデータが分散され、並列読み書きが可能になるためパフォーマンスが向上する（キュー深さによる）。  
- VMのマシンタイプやCPU数を増やすことでもパフォーマンスに影響する。

---

## 物理ハードドライブとの比較
- 物理ディスクと同等のパフォーマンスを出すには永続ディスクのサイズを増やす必要がある。  
- 例えば、SSD永続ディスクなら約3GBで物理ディスク相当の性能、標準永続ディスクでは約100GBが必要。  
- パフォーマンスはタイプごとに異なり、右に行くほど性能が高い。

---

## ディスクサイズ別パフォーマンス例
- サイズが大きいほど読み書き速度やIOPS（入出力操作数）が向上。  
- SSD永続ディスクは標準永続ディスクより少ない容量でも高い性能を発揮する。

---

## パフォーマンス最適化のポイント
- 永続ディスクのサイズを大きくする。  
- VMのマシンタイプ・CPU数を増やす。  
- その他ネットワーク帯域、同時書き込み数、ボリュームサイズなども影響。

---

## ローカルSSDのパフォーマンス
- ローカルSSDは物理的にVMと同じホストに接続されるため、最も高いパフォーマンスを発揮。  
- サイズを増やすとさらに性能向上。  
- ただし、VMのライフサイクルと連動し、VM停止・削除でデータ消失のリスクあり。  
- コストも高め。

---

## まとめ
- ブロックストレージのパフォーマンスは「ディスクタイプ」と「サイズ」が大きく影響。  
- パフォーマンス重視ならローカルSSDの検討が有効。  
- 永続ディスク利用時はサイズを大きくし、VMのスペックも上げることでパフォーマンス改善が可能。

# 20. 永続ディスクのスナップショット

---

## スナップショットとは
- 永続ディスク（ゾーンディスク、リージョンディスク問わず）のバックアップ機能。  
- スナップショットはグローバルリソースで、全ゾーンから新しいVMやディスクの作成に利用可能。  
- 実行中のVMからでもスナップショット作成が可能。

---

## 利用例
- あるゾーンのコンピュートエンジンのディスクをスナップショットでバックアップし、別ゾーンで新たなVMを作成できる。  
- 2ステップで簡単にディスク複製やVM復元ができる。

---

## スナップショット作成手順（概要）
- VM作成時に追加ディスクを付けることも可能。  
- 作成したディスクから新規スナップショットを作成。  
- スナップショットの配置場所（リージョン or マルチリージョン）を指定可能。  
- 複数リージョンに置くことで可用性向上が可能。  

---

## アプリケーション整合性 vs クラッシュ整合性
- **アプリケーション整合性**  
  - スナップショット作成時にアプリケーションの状態を正しく保存。  
  - 次回復元時にアプリが正常に動作する保証がある。  
  - Windows/Linuxで仕組みが異なる。  
- **クラッシュ整合性**  
  - ファイルのクローズ状態などを考慮せず即時スナップショットを取得。  
  - 復元後にアプリが正常に動くかは保証なし。  
- アプリケーションがないデータディスクなどはクラッシュ整合性で十分な場合もある。

---

## スナップショットからの復元
- スナップショットを指定して新規VMやディスクを作成可能。  
- 元のVMとは異なる設定（例：名前）で作成できる。

---

## スナップショットのスケジュール機能
- スナップショット作成の自動化が可能。  
- 時間単位（例：6時間毎）、日単位、週単位など細かく設定できる。  
- 古いスナップショットの自動削除設定も可能（例：14日経過後に削除）。  
- アプリケーション整合性の有無もスケジュールに含めて設定可能。  
- 災害時の迅速な復元と古いバックアップの自動クリーンアップに役立つ。

---

## まとめ
- 永続ディスクのスナップショットはバックアップ・復元に便利で柔軟性が高い。  
- 手動・自動の両方でスナップショット作成が可能。  
- 複数リージョンに配置して可用性を高めることができる。  
- アプリケーションの状態に応じて整合性レベルを選択可能。

# 21. メンテナンスイベント

---

## メンテナンスイベントとは
- GCPプラットフォームの各ゾーンで定期的に行われるインフラのメンテナンス。  
- コンピュートエンジン上の仮想マシン（VM）は物理ホストマシン上で動作している。  
- 物理ホストマシンのメンテナンス時にVMの稼働を止めずに移動する仕組みがある。  

---

## ライブマイグレーション
- 稼働中のVMを停止せず別のホストマシンに移動する技術。  
- デフォルトでライブマイグレーションが行われ、アプリケーションやワークロードにほとんど影響なし。  
- 通常約2週間に1回の頻度で実施される。  
- 「透過的メンテナンス」と呼ばれる。

---

## 透過的メンテナンスの内容
- システムパッチ適用や予防的メンテナンスを実施。  
- ハードウェアの不良修理、BIOSやホストOSのアップグレードなど多岐に渡る。  
- 予期せぬ問題（ネットワーク障害、メモリーリークなど）にも対応可能。  

---

## メンテナンスの設定オプション
- デフォルトはライブマイグレーション。  
- 他に「ホスト停止してVM停止・再起動」も選択可能。  
- 再起動の自動実行のON/OFFも設定可能。  

---

## メンテナンスイベントのシミュレーション
- コマンドでメンテナンスイベントをシミュレート可能。  
- 実際にライブマイグレーションを試し、影響を確認できる。  
- ライブマイグレーション中もVMは稼働し続け、Pingコマンドも途切れず正常動作。  

---

## メンテナンスイベントのログ確認
- ログでメンテナンス（ライブマイグレーション）の実施を確認できる。  
- オペレーション履歴やイベントログに記録される。

---

## まとめ
- GCPのメンテナンスイベントはほぼ無停止でインフラを維持する仕組み。  
- ライブマイグレーションにより、ダウンタイムなしでホストのメンテナンスが可能。  
- ユーザーはVM作成時にメンテナンス時の動作設定ができる。  
- シミュレーションやログ確認もできて、運用管理がしやすい。

# 22. マシンファミリーとマシンタイプ

---

## 概要
- GCPのVMインスタンス作成時に「マシンファミリー」と「マシンタイプ」を選択可能。  
- リージョンによって選択できるファミリーやタイプが異なる。  
- 選択によって価格やパフォーマンスが大きく変わる。  
- 必要なコンピュートリソースに応じて適切なタイプを使い分けることが重要。  

---

## マシンファミリーの種類（主に4つ）

### 1. 汎用ファミリー
- 価格と性能のバランスが良い。  
- データベース、開発環境、テスト環境、WEBアプリ、モバイルなど幅広く利用可能。  
- CPUコア数やメモリをカスタム調整可能（シリーズによって調整可能範囲が異なる）。  
- シリーズ例：N1シリーズ、E2シリーズ、N2シリーズなど。  
- 大きなメモリ（最大624GBなど）や多コア（最大96コア）まで選択可能。  

### 2. コンピューティング最適化ファミリー
- 1コアあたりの性能が最も高い。  
- 高負荷な計算処理に最適（例：ゲームサーバー、レイテンシーに敏感なAPI）。  
- 4コア〜16コアなどの構成が選べる。  

### 3. メモリー最適化ファミリー
- 大容量メモリ搭載が特徴（最大12TBメモリまで可能）。  
- 大規模インメモリDBや分析処理に適している（例：SAP HANAなど）。  
- リージョンによっては未対応の場合あり。  
- 価格は非常に高額になることもある（例：月130万円以上）。  

### 4. アクセラレータ最適化ファミリー
- GPUを搭載可能。  
- 機械学習や高度な並列計算処理に最適。  
- 最大16個のGPUコアを利用可能。  
- 主にN1シリーズに対応。  

---

## シリーズと特徴
- 汎用ファミリー内にも複数のシリーズがある（N1、E2、N2など）。  
- シリーズによってCPUの種類や性能、カスタム可能範囲が異なる。  
- 例：  
  - N1シリーズ：最大96コア、624GBメモリ  
  - N2シリーズ：最大80コア、640GBメモリ  
  - E2シリーズ：コスパが良いがカスタム範囲が限定的  
- CPUプラットフォームの選択肢もシリーズによって異なる。  

---

## プリエンプティブVMについて
- GCPがリソース必要時に強制停止する可能性あり。  
- 割引価格で提供される。  
- メモリー最適化シリーズを除く全シリーズで利用可能。  

---

## 選択のポイント
- 用途に応じてマシンファミリーを選ぶ。  
- 計算負荷重いならコンピューティング最適化、メモリ大量ならメモリー最適化、汎用的なら汎用ファミリー。  
- コストと性能のバランスを考慮することが重要。  
- 公式ドキュメントで詳細や最新情報を必ず確認する。  

---

## まとめ
- GCPのマシンファミリーは大きく4種あり、用途に応じて使い分ける。  
- マシンタイプ（シリーズやカスタム設定）によって性能や価格に差が出る。  
- リージョンによって利用可能なファミリー・タイプが異なるため注意が必要。  
- 高性能GPU搭載VMも利用可能で、機械学習用途に適している。  
# 23. インスタンステンプレート

---

## 概要
- インスタンステンプレートは、VMインスタンスを作成するためのテンプレートリソース。  
- このテンプレートを使って同じ構成のVMを複数作成可能。  
- マネージドインスタンスグループでのVM作成にも利用される。  

---

## インスタンステンプレートの特徴
- マシンタイプやブートディスクイメージ（LinuxやWindowsなど）を定義。  
- 作成方法は通常のVM作成に近い。  
- テンプレートはグローバルリソースなので、異なるゾーンやリージョンで利用可能。  
- 一度作成するとテンプレート自体の更新や変更はできないが、作成時のパラメータ編集は可能。  
- テンプレートの利用自体は無料。実際にVMを稼働させた際に課金が発生。  

---

## 利用手順（主な流れ）
1. インスタンステンプレートを作成  
   - 名前、マシン構成（例：マシンタイプ、ブートディスク）、ネットワーク、ファイアウォール設定などを指定。  
   - メンテナンスポリシーやプリエンプティブVMの設定も可能。  
2. テンプレートからVMインスタンスを作成  
   - 作成時にリージョンやゾーンを指定でき、マシンタイプなども変更可能。  
   - 作成時に設定の不整合がある場合はエラーになることもあるため注意。  

---

## 注意点
- テンプレート作成時に設定した内容と整合が取れない場合、VM作成時にエラーになることがある。  
- プリエンプティブVMでない場合、特定のメンテナンス設定は利用できない。  

---

## まとめ
- インスタンステンプレートは、同じ構成のVMを効率的に複製・作成するための便利な仕組み。  
- マネージドインスタンスグループや複数VM展開の際に活用される。  
- 他にもデプロイメントマネージャーやVMの複製機能など、同様の用途を持つツールがあるが、テンプレートはその一つ。  

# 24. Managed Instance Group の概要

---

## 概要
- **マネージドインスタンスグループ（MIG）**は、同じワークロードの複数のCompute Engineインスタンスをグループ化して管理する仕組み。  
- インスタンスグループには「マネージド」と「非マネージド」があり、MIGは同じテンプレートを基にインスタンスを複製・管理。  
- 主にロードバランサーのバックエンドとして利用されることが多い。  

---

## 主な用途
- ステートレスなワークロード（例：Webサイト、フロントエンド、WEBアプリケーション）  
- バッチ処理や画像処理などの大量処理にも対応可能  
- 最近はステートフルワークロード（状態を持つアプリケーション）にも対応可能に  

---

## メリット
- **高可用性**  
  - 複数インスタンスで構成し、一部が停止してもサービス継続可能。  
  - 複数ゾーンに分散配置し、ゾーン障害にも耐えられる構成が可能。  
- **スケーラビリティ**  
  - インスタンス数の増減が簡単（自動スケーリング対応）。  
  - トラフィック増加時にスケールアウト、減少時にスケールインが可能。  
- **自動更新**  
  - ソフトウェアや構成の自動アップデートをサポート。  
- **ヘルスチェックと自動修復**  
  - 調子の悪いインスタンスは自動的に再作成される。  

---

## 利用イメージ
- コンピュートエンジンの管理画面からインスタンスグループを作成  
- インスタンステンプレートに基づきインスタンス複製  
- 配置はシングルゾーンまたはマルチゾーンを選択可能  
- スケーリングの設定（最小・最大インスタンス数、指標はCPU使用率やロードバランサー負荷など）  
- ポートマッピングやロードバランサー連携も設定可能  

---

## 実際の操作例
- マネージドインスタンスグループの作成画面で名前やリージョン、ゾーン、インスタンス数、テンプレートを指定  
- スケーリングやヘルスチェック設定を行う  
- 作成後は状況のモニタリング、インスタンス数の変更、再起動、削除などが可能  

---

## 注意点
- コンソールから削除できない不具合がある場合は、`gcloud`コマンドでインスタンスグループをリスト・削除する方法がある。  
  - 例: `gcloud compute instance-groups managed delete [GROUP_NAME] --zone [ZONE_NAME]`  

---

## まとめ
- マネージドインスタンスグループは、同じワークロードのCompute Engineインスタンスを効率よく管理・スケール・修復するための重要な機能。  
- ロードバランサーと組み合わせて高可用性かつ柔軟なクラウド環境を構築できる。  

# 25. ステートフルMIG（Managed Instance Group）概要

---

## ステートフルMIGとは
- ステートフルMIGは、**状態（ステート）を持つインスタンス群を管理できる**マネージドインスタンスグループ。  
- 従来のステートレスMIGはインスタンスに状態を持たせず、インスタンス削除時に状態（ディスクやIPアドレスなど）が失われる。  
- ステートフルMIGでは、**VMインスタンスの削除・再作成があっても、ディスクやIPアドレス、メタデータなどの状態を保持できる**。  

---

## ステートフルMIGの特徴と制限
| 機能                       | ステートレスMIG | ステートフルMIG  |
|----------------------------|-----------------|------------------|
| 自動スケーリング           | 可能            | 不可             |
| 自動修復                   | 可能            | 可能             |
| ローリングアップデート     | 可能            | 可能             |
| マルチゾーンデプロイ       | 可能            | 可能             |
| ステート保持（ディスク等） | なし            | あり             |

- ステートフルMIGは2022年3月時点でプレビュー版。  
- 自動スケーリングは使えない点に注意。  

---

## ステートの定義方法
- ステートレスMIGは「インスタンステンプレート」のみを使用。  
- ステートフルMIGでは以下の定義を組み合わせる形：  
  1. **ステートフルポリシー**（共通で適用される状態、例：永続ディスク）  
  2. **個別インスタンスに対するステート定義**（例：固定IPアドレスやメタデータなど）  

- これらの定義により、インスタンスの再作成時に指定した状態を保持し、新規に作成し直すのではなく既存のリソースを再利用可能。  

---

## 利用シーン・ユースケース
- データベースサーバー（例：Cassandra、Elasticsearch、MongoDB、Zookeeper）  
  - ただし、GCPのマネージドリレーショナルDBサービス利用推奨  
- 分散データ処理やメッセージング（例：Kafka）  
  - GCPのDataflowやDataprocなどマネージドサービスの利用も検討  
- モノリシックアプリケーションでIPアドレスやディスクなど状態を維持したい場合  
- 長時間演算・チェックポイント処理を行い、障害時に再開可能なバッチ処理など  

---

## ステートフルMIGの構成と操作
- 作成時はインスタンステンプレートを指定し、ステートフルポリシーや個別ステートを設定  
- ロードバランサーのバックエンドとして配置可能  
- VMが再起動・再作成される際に、設定した状態（ディスクやIPなど）を維持し復元可能  
- `gcloud`コマンド等でステートフル設定を行うことが多い  

---

## まとめ
- ステートフルMIGは、状態を保持したいワークロードに対してVMインスタンスの可用性を保ちながら運用可能にする新しい仕組み。  
- 自動スケーリングが使えないため用途は限定的だが、特定のユースケースでは有効。  
- 現状はプレビュー版であり、フィードバックや利用例の共有が呼びかけられている。  

# 26. 非マネージドインスタンスグループ（Unmanaged Instance Group）概要

---

## 非マネージドインスタンスグループとは
- インスタンスグループの一種だが、**マネージドされていないグループ**。  
- 主に**単一ゾーン内のVMをグループ化**して管理する。  
- グループ内のVMは**同じVPCネットワーク、同じサブネットに存在する必要がある**。  
- 個々のVMに異なる構成やチューニングが必要な場合に便利。  

---

## 特徴と用途
- マネージドインスタンスグループとの大きな違いは、**異なるワークロードのVMも同じグループに含められること**。  
- ロードバランサーのバックエンドとして設定可能。  
- ただし異なるワークロードを混在させると構成が複雑になるため、実務上はあまり推奨されない。  
- 自動スケーリングなどのマネージド機能は使えない。  

---

## 作成時の注意点
- グループ化するVMは**必ず同じゾーンに配置されている必要がある**（同じリージョンでも異ゾーンは不可）。  
- ネットワーク（VPC）やサブネットも統一が必要。  
- 作成時にグループに含める既存のVMを選択して登録する。  

---

## 操作・管理
- グループのメンバーVMを一覧で確認可能。  
- モニタリングや詳細設定はマネージドインスタンスグループと同様に行える。  
- 自動スケーリングはできないため、インスタンスの増減は手動管理が必要。  

---

## まとめ
- 非マネージドインスタンスグループは管理は限定的だが、**異なるワークロードのVMを束ねたり、手動でVMを管理したい場合に有効**。  
- 運用やスケーリングの自動化が不要なケースで利用される。  

# 27. OSのパッチ適用

---

## 概要
- OSのシステムパッチ適用の仕組みが変わり、以前の「アクティビティログ」確認から「VMマネージャー」を使用する方法へ移行。
- VMマネージャーは3つのコンポーネントで構成される。
  - **OSパッチマネジメント**：パッチ適用のスケジューリングや実行管理。
  - **OSインベントリマネジメント**：ホスト名やOSバージョン、カーネルバージョンなどの情報収集。
  - **OSコンフィギュレーションマネージャー**：インストールされているソフト管理（インストール・削除・自動更新）。

---

## VMマネージャーの特徴
- 1時間あたり1VMにつき約0.0003ドルの課金。
- 複数VMを効率的に管理できるツール。
- OSCONFIGエージェントがほとんどのVMにプリインストールされている（RedHat、Debian、CentOS、Linux系、Windowsなど）。
- ただしメタデータの有効化が必要で、APIも有効にしないとエージェントはアイドル状態のまま。

---

## 構成イメージ
- ユーザーはVMマネージャーを介してVMを管理。
- VM内のOSCONFIGエージェントがOSユーティリティと連携し、インターネット経由でパッチを取得・適用。

---

## パッチ適用の流れ
1. VMインスタンスを作成。
2. メタデータでOSCONFIGエージェント機能を有効化（カスタムメタデータに`TRUE`設定）。
3. VMマネージャーの「OSパッチ管理」からパッチデプロイを設定。
   - ターゲットのゾーン・リージョンを指定。
   - パッチデプロイ名、構成、スケジュール（今すぐ開始、予約、繰り返しなど）を設定。
   - ロールアウト方式（ゾーン単位など）や再起動の有無を選択。
4. パッチデプロイを実行し、進捗や結果をレポートで確認。

---

## 実際の運用
- パッチ適用ジョブは正常に完了し、対象インスタンスのパッチ適用状況やインストール済みパッケージ情報が確認可能。
- VMにエージェントは最初から入っているが、メタデータの有効化を必ず行う必要がある。
- OSパッチの自動化・一元管理やスケジューリングによる運用管理が可能。

---

## まとめ
- 旧来のアクティビティログ方式からVMマネージャーによる管理へ移行し、より効率的にOSパッチを適用・管理できる。
- メタデータの有効化が必須であり、API設定も必要。
- 複数VMを対象にスケジューリングや手動でのパッチ適用が可能で、運用負荷軽減に役立つ。

# 28. コマンドラインによるインスタンスの作成

---

## 概要
- これまでVMインスタンスはGCPのコンソール画面から作成していたが、実は背後でAPIを通じて作成している。
- VM作成は以下の方法で可能：
  - GCPコンソールのGUI
  - コンソール内のクラウドシェルでgcloudコマンドを使う
  - ローカルPCにCloud SDKをインストールしgcloudコマンドを使う
  - アプリケーションからAPI経由で操作する

---

## APIの有効化
- インスタンス作成には「Compute Engine API」を有効化する必要がある。
- 新規プロジェクトではAPIは無効状態なので、まずAPIとサービス画面で「Compute Engine API」を検索し有効化する。
- または、gcloudコマンド実行時にAPI有効化の許諾を求められ、許諾すれば自動的に有効化される。

---

## コマンド例
- 公式ドキュメントにある`gcloud compute instances create`コマンドを利用。
- マシンタイプやゾーン、インスタンス名などオプションを指定してインスタンスを作成する。

---

## 実演内容
1. クラウドシェルを起動。
2. APIが無効な状態でコマンド実行し、API有効化の確認が表示される。
3. 有効化を許諾し、APIが有効化される。
4. 再度コマンドを実行し、VMインスタンスが作成される。
5. GCPコンソールのインスタンス一覧画面で作成されたVMを確認。

---

## まとめ
- APIを有効にしてからコマンドラインでインスタンス作成を行う必要がある。
- クラウドシェルやローカルのCloud SDK、アプリケーションからも同様にAPI経由で作成可能。
- コマンドライン操作に慣れることで自動化やスクリプトによる管理がしやすくなる。

# 29. インスタンスのサービスアカウントの有効化

---

## サービスアカウントとは
- VMインスタンス作成時にデフォルトで割り当てられる特殊なアカウント。
- アプリケーションがGCPリソースにアクセスする際の認証情報として機能する。
- サービスアカウントに付与されたIAM権限の範囲内でAPI操作が可能。
- 例：コンピュートエンジンからクラウドストレージへのアクセス権限を制御できる。

---

## 特徴と利用法
- サービスアカウントは複数VMで使い回し可能だが、1つのVMに割り当てられるサービスアカウントは1つのみ。
- デフォルトの「コンピュートエンジンデフォルトサービスアカウント」は編集者ロールを持ち、多くの権限がある。

---

## 実践例
- VMインスタンス作成時にデフォルトのサービスアカウントが割り当てられていることを確認。
- 非公開のクラウドストレージバケット内の画像ファイルへ、VMから`gsutil`コマンドでアクセス可能。
- ブラウザのゲストモードからは認証されていないためアクセス不可。

---

## 権限管理のポイント
- IAM管理画面でサービスアカウントに割り当てるロールを変更できる。
- 例：
  - 「参照者」ロール：クラウドストレージのアクセス不可
  - 「閲覧者」ロール：クラウドストレージのオブジェクト閲覧可能
- 権限変更は反映までに時間がかかることがある（結果整合性）。

---

## サービスアカウントの切り替え手順
1. 新しいサービスアカウントを作成し、必要なロールを割り当てる。
2. 対象のVMインスタンスを停止。
3. インスタンス設定画面でサービスアカウントを切り替え、保存。
4. インスタンスを再起動して設定を反映。
5. アクセス権限を確認し、動作を検証。

---

## まとめ
- サービスアカウントはVMインスタンスのGCPリソースアクセス権限を管理する重要な仕組み。
- デフォルトのサービスアカウントは編集者権限を持ち、多くのアクセスが可能。
- アクセス権限はIAMロールで細かく制御可能。
- 複数VMでサービスアカウントを共有できるが、1VMに割り当てられるのは1つのみ。
- 設定変更は反映に時間がかかることがあるため注意が必要。

# 30. プリエンプティブルVMインスタンス

---

## 概要
- 通常のVMインスタンスより約7割安い低価格で利用できる特殊なVMインスタンス。
- GCPプラットフォームの余剰リソースを利用する仕組み。

---

## 特徴と制限
- **突然停止の可能性あり**  
  プラットフォーム側でリソースが必要になると強制的に停止される可能性がある。
- **24時間稼働後は必ず停止**する仕様。
- **ライブマイグレーション不可**  
  メンテナンスイベント時の自動再起動設定もできない。
- **SLA（サービスレベル保証）なし**  
  障害時の補償やクレジット返却なし。
- **無料枠適用外**。

---

## 利用に適したケース
- フォールトトレラント設計のアプリケーション
- バッチ処理や分散計算ジョブ
- 継続的デリバリーのジョブ処理

---

## 実践操作ポイント
- VM作成時の「管理」→「可用性ポリシー」で「プリエンプティブ」を有効化する（デフォルトはオフ）。
- プリエンプティブを有効にするとメンテナンスの自動再起動設定は利用不可になる。
- その他の設定は通常のVMと同様。
- インスタンス作成後は通常通りSSH接続やプログラム実行が可能。

---

## まとめ
- プリエンプティブルVMは低コストだが、突然停止リスクと制限があるため用途が限定される。
- 途中停止しても問題ないバッチ処理や分散処理に最適。
- コスト削減に有効な選択肢の一つ。

---

## 詳細は公式ドキュメントを参照
