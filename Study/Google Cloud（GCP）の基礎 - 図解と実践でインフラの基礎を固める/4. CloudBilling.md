# 38. CloudBillingの概要

GCPの利用料金の支払いと請求の仕組みについて説明します。

## 全体構造と主要コンセプト

- **リソース階層構造**  
  組織 → フォルダ → プロジェクト → リソース（Compute Engine、Cloud Storageなど）

- **新しい概念**  
  - **ドメイン**  
    Google WorkspaceやCloud Identityなどのユーザー管理の単位。1つのドメインに1つの組織が関連付けられる。  
  - **ラベル**  
    リソースやプロジェクトに付与するKey-Valueペア。費用分析やフィルタリングに利用可能。  
  - **ビリングアカウント（請求先アカウント）**  
    請求の単位で、複数のプロジェクトを紐づけられる。  
  - **ペイメントプロファイル（支払いプロファイル）**  
    名前・住所・納税番号・クレジットカード情報などの支払い情報を管理。ビリングアカウントに紐づく。  

## 支払いの流れ

- 各プロジェクトはビリングアカウントに紐づけられ、そのビリングアカウントに対して支払いが行われる。  
- ペイメントプロファイルはビリングアカウントと関連付けられ、複数のビリングアカウントと関連付け可能。  

## 実際のGCP画面の確認ポイント

- **お支払いタブ**で請求情報の確認・設定が可能。  
- アカウント管理では、ビリングアカウントに紐づいたプロジェクトを一覧できる。  
- 支払いプロファイルの詳細（住所、アカウント種別、支払い方法）も確認・管理できる。  
- 課金データをBigQueryにエクスポートし、ラベルを活用して詳細な費用分析が可能。  
- 新しい請求先アカウント（ビリングアカウント）を追加作成できる。  

---

クラウドビリングはGCP利用における重要な要素であり、これらの構造と概念を理解することが重要です。

# 39. Cloud Billingのアクセス制御の概要

GCPの請求・支払いに関するアクセス権を適切に管理するための仕組みについて解説します。

---

## 1. 請求構造の基本

- **組織 → ビリングアカウント（請求先アカウント） → プロジェクト**
- 各ビリングアカウントは、1つ以上のプロジェクトに紐づけ可能
- ビリングアカウントは **ペイメントプロファイル（支払い情報）** と連携

---

## 2. 主要な6つのロール（役割）

| ロール名                           | 権限の概要                                                                 |
|------------------------------------|---------------------------------------------------------------------------|
| 請求先アカウント作成者             | 新しいビリングアカウントを作成できる                                      |
| 請求先アカウント管理者             | ビリングアカウントの全般的な管理（支払方法管理、エクスポート等）            |
| 請求先アカウントユーザー           | プロジェクトをビリングアカウントにリンクする                              |
| 請求先アカウント閲覧者             | 利用額やトランザクションの閲覧が可能（主に財務チーム向け）                |
| 請求先アカウントの費用の管理者     | 費用の表示やエクスポートのみ可能（閲覧者より制限された役割）              |
| プロジェクトの支払い管理者         | プロジェクトとビリングアカウントのリンク・解除の操作（プロジェクトレベル） |

---

## 3. ロール設定の注意点

- **IAMの「ロール追加」画面**では、基本的に「プロジェクトの支払い管理者」以外は設定不可。
- 他のロールは、**「お支払い」メニュー → アカウント管理者** 画面から設定。
- 「情報パネルを表示」し、「プリンシパルの追加」から設定する。

---

## 4. 組織構成に応じたロールの割り当て例（シナリオ）

### ✅ 小規模企業（例1）
| 役割 | 担当者 |
|------|--------|
| 請求先アカウント管理者 | CEO（支払い管理） |
| プロジェクトの支払い管理者 | CTO（プロジェクト作成・請求リンク） |
| その他 | 開発チーム（GCP利用のみ） |

---

### ✅ 中小企業（委任型）（例2）
| 役割 | 担当者 |
|------|--------|
| 請求先アカウント作成者・管理者 | CEO / CFO |
| 費用の管理者・閲覧者 | 経理部門 |
| プロジェクトの支払い管理者 | 開発チーム |

---

### ✅ 大規模組織（例3）
| 部門 | 権限 |
|------|------|
| IT部門 | 請求先アカウント管理者・アラート管理 |
| 財務部門 | 請求先アカウント閲覧者（費用分析・報告） |
| 買掛部門 | 請求先アカウント閲覧者（請求処理） |
| 開発チーム | プロジェクトの作成と請求連携（管理はIT） |

---

### ✅ 大型プロジェクト運用（例4）
| 担当者 | 権限 |
|--------|------|
| 社長・CFO | 請求先アカウント管理者・費用アラート設定 |
| プロジェクトリーダー | プロジェクト作成・請求管理 |
| チームメンバー | GCP使用のみ（設定なし） |

---

## 5. まとめ

- **6つの主要なロール**を理解し、組織・プロジェクトに応じて適切に割り当てることが重要。
- 設定場所（IAM or Billing）に注意が必要。
- 適切なアクセス制御はセキュリティ・管理・コスト最適化に不可欠。

# 40. 予算とアラート（GCP Cloud Billing）

GCPでは、プロジェクトの利用料金をモニタリングし、**想定外の請求を防ぐ**ために「予算とアラート」の設定が可能です。

---

## ✅ 基本概要

- 利用料金に対して「予算（バジェット）」を設定し、しきい値を超えたら**管理者へ通知**。
- 課金の**自動停止は行われない**（※通知のみ）。
- **スクリプトやクラウド関数（Cloud Functions）**を使えば、課金超過時にプロジェクトを自動停止する仕組みを作ることも可能。

---

## ✅ 通知方法（3つのパターン）

1. **Billingアカウント管理者宛メール通知**
2. **Cloud Monitoring経由のカスタム通知（最大5人）**
3. **Pub/Sub → Cloud FunctionsやAPI連携で自動対応**

---

## ✅ バジェット作成の流れ

1. **お支払いメニュー → 「予算とアラート」** を開く  
2. **新しい予算を作成**：
   - 名前設定
   - 期間：月単位／四半期／年／カスタム
   - 対象：プロジェクト／サービス／SKU
   - 金額：固定額 or 前月比
   - 割引・無料枠の扱いを選択可
3. **通知の閾値（例：50%, 90%, 100%）** を設定
4. **通知方法を選択**
5. **保存して完了**

---

## ✅ 注意点

- 予算を超えても、**自動でGCPのサービスは停止されない**。
- **Pub/Sub + Cloud Functions + Billing API** で自動停止は可能（高度な構成）。
- 通知は複数条件で設定可能。
- 予算はグラフ表示で利用状況を可視化できる。

---

## ✅ 自動停止の参考資料

- GCP公式で紹介されている方法あり：
  - 「課金を上限に設定し、使用を停止する方法」
  - 使用技術例：Node.js、Python、Pub/Sub、Billing API

🔗 公式ガイド（※実際のURLはブラウザで検索）

---

## ✅ まとめ

- GCPのコストを適切に管理するために、**予算とアラートは必須**。
- 通知は3通り。自動化も可能だが、手動設定でも十分に運用可能。
- 複数プロジェクトやサービス単位で細かな制御が可能。

# 41. 請求データの BigQuery エクスポート

GCP のクラウドビリングにおける請求データを **BigQuery にエクスポート** し、詳細分析を行う方法の紹介です。

---

## ✅ BigQueryとは？

- GCPのマルチクラウド・データウェアハウス
- **データ保管 + 分析** の両方が可能
- 大規模な課金データの集計・可視化に最適

---

## ✅ エクスポートの概要

- **クラウドビリングの請求データをBigQueryへ自動エクスポート**
- 使用量、料金、プロジェクト、SKU単位など、**詳細な課金データ**を含む
- **レポート機能の補完・強化**として活用可能

---

## ✅ エクスポートの設定手順

1. **対象プロジェクトを用意（課金有効化済み）**
2. **BigQuery Data Transfer APIを有効化**
3. **BigQueryでデータセットを作成**
4. **お支払い画面から課金データのエクスポートを設定**
   - 標準 or 詳細のエクスポートを選択
   - データセットを指定
5. **最初のエクスポートには最大48時間かかる場合あり**

---

## ✅ 取得可能なデータ項目（例）

- プロジェクトID・名前・ロケーション
- 通貨・使用量・課金単位
- タイムスタンプ
- VMやストレージ等のリソース単位の課金データ

---

## ✅ 非推奨の方法：Cloud Storage へのファイル出力

- CSV / JSON形式での出力も可能
- ただし **非推奨（公式でも明示）**

---

## ✅ BigQueryの利用料金

- **保存：毎月10GBまで無料**
- **分析：毎月1TBまで無料**
- 多くのケースで無料枠内に収まるが、課金発生の可能性あり

🔗 詳細：[BigQuery 料金ページ（公式）](https://cloud.google.com/bigquery/pricing)

---

## ✅ 可視化：Looker Studio（旧：Data Portal）

- BigQueryに格納された請求データをグラフ等で可視化可能
- 例：
  - プロジェクト別コスト
  - チーム別利用状況
  - 月別課金推移

---

## ✅ クエリ例（BigQueryでの分析）

- 月ごとの請求額合計
- 請求書別料金タイプ（税金、調整、エラーなど）
- 使用サービス単位の分析

※ SQL文により柔軟な分析が可能（STLライク）

---

## ✅ まとめ

- **クラウドビリング × BigQuery** により、請求データを詳細に把握可能
- 自動エクスポート＋SQL分析＋可視化で高度なコスト管理が可能
- **Cloud Storageへのエクスポートは非推奨**、BigQueryを推奨
- 初期設定は少し手間だが、長期的に大きなコスト最適化が可能


# 小テスト4: Cloud Billing（クラウド課金）

Google Cloud の課金（Cloud Billing）に関する理解度を確認する小テストの要点を以下にまとめます。

---

## ✅ 課金アカウント（Billing Account）

- GCPのリソース利用における**支払い単位**
- プロジェクトごとに課金アカウントを**紐づける**必要がある
- 課金アカウントは**組織単位または個人アカウント**で所有可能

---

## ✅ プロジェクトと課金アカウントの関係

- 1つのプロジェクトには**1つの課金アカウント**しか紐づけられない
- ただし、**1つの課金アカウントには複数のプロジェクト**を紐づけ可能

---

## ✅ 支払い責任者（Billing Admin）

- Cloud Billing の設定管理者
- 課金情報の確認、請求書の取得、支払い方法の設定などを担当
- **プロジェクトの IAM 管理者とは別権限**

---

## ✅ コストの可視化

- GCP では複数の**課金レポート機能**を提供：
  - **費用明細書（Invoices）**
  - **課金ダッシュボード**
  - **費用分析（Cost Table / Cost Breakdown）**
- **BigQuery との連携で詳細分析も可能**

---

## ✅ 無料枠とトライアル

- 多くのサービスに**Always Free（常時無料）枠**あり
- 初回登録時に$300分の**無料トライアルクレジット**
- 無料枠を超えると自動で課金が開始される

---

## ✅ リソース階層と請求

- 課金はプロジェクト単位で行われる
- 組織 > フォルダ > プロジェクト の階層構造で管理
- **課金ポリシーや予算アラート**はプロジェクト単位で設定可能

---

## ✅ よく出る確認ポイント（小テスト対策）

| 項目 | チェック |
|------|----------|
| プロジェクトに課金アカウントは何個紐づけられる？ | 1つだけ |
| 1つの課金アカウントに紐づけられるプロジェクト数は？ | 複数OK |
| 請求明細を最も詳細に分析するには？ | BigQueryと連携 |
| 無料枠超過時の挙動は？ | 自動課金開始（通知あり） |
| 組織全体のコスト監視方法は？ | コストアラート / BigQuery / Looker Studio |

---

## ✅ 補足

- GCP では組織全体の予算やアラートを設定し、**コスト超過を未然に防ぐ**ことが可能
- 大規模利用時は、**ラベルや請求先アカウントの設計**が重要になる

---

## ✅ まとめ

Cloud Billing は GCP 利用における基盤的な仕組みであり、次のことがポイント：

- プロジェクトと課金アカウントの1対1対応
- BigQuery 連携による高度な請求分析
- IAMロールにより権限を適切に分離
- 無料枠と通知機能でコスト管理が可能

