# 60. BigQueryの概要

## BigQueryとは？

- Google Cloudが提供する**サーバーレスのデータウェアハウス**
- **データの保存**と**分析クエリの実行**の両方を担う
- **高いスケーラビリティ**と**高速なクエリ実行性能**
- **サーバーレスアーキテクチャ**：ユーザーがインフラ管理不要
- **超大量（ペタバイト級）データ**にも対応

---

## 主な特徴

- **無料枠あり**：ストレージ10GB、クエリ月1TBまで無料
- **料金体系**：
  - ストレージ：約1円/GB/月
  - クエリ：600円/1TBスキャン（オンデマンド）
  - **定額料金プラン**もあり
- **高コストパフォーマンス**：他のDWHと比較して費用削減効果あり（最大34%削減）

---

## 代表的な利用例

- ゲーム業界やWebサービスにおけるログデータ分析
- **分析処理はBigQuery、データ保存はCloud StorageやMySQL** などの組み合わせで利用
- 例：ゲームデータをBigQueryで分析 → ゲームサーバーへ反映

---

## データ操作方法

### データセットとテーブルの作成

1. **プロジェクト内にデータセットを作成**
   - 名前はアンダースコア使用（ハイフン不可）
   - データ保存場所（ロケーション）や暗号化方式を選択
2. データセット内に**テーブルを作成**
   - 空のテーブル、CSVアップロード、Cloud Storage連携、AWSからのインポートなど対応

### SQLでの分析

- BigQueryはSQL文でデータにアクセス・分析
- 例：
  ```sql
  SELECT * FROM `bigquery-public-data.sample_table` LIMIT 1000;
  ```

公開データセットの活用
BigQueryではGoogleが提供する公開データセットを無料で分析可能

例：Google Trends、COVID-19、病院ベッド数データなど

クエリ前に「ドライラン（Dry Run）」で実行コストを事前確認可能

クエリの実行例

  ```
SELECT * 
FROM `bigquery-public-data.covid19_open_data.covid19_open_data` 
LIMIT 1000;
  ```
クエリ実行時に処理対象データ量や想定コストを確認可能

処理結果や実行時間も表示される（例：0.4秒）

まとめ
BigQueryはサーバーレスでスケーラブルなデータウェアハウス

保存コストと分析コストが分離されており、利用量に応じた柔軟な料金設計

大規模データ分析に最適で、エンタープライズから個人まで幅広く利用可能

公開データや様々なインポート方法で柔軟なデータ連携が可能

公開データセットの活用
BigQueryではGoogleが提供する公開データセットを無料で分析可能

例：Google Trends、COVID-19、病院ベッド数データなど

クエリ前に「ドライラン（Dry Run）」で実行コストを事前確認可能
61. bqコマンドの使い方
概要
このレクチャーでは、Google BigQuery をコマンドラインから操作する bq コマンドの基本的な使い方を紹介します。GUI で行っていたクエリ実行を、CLI（コマンドラインインターフェース）で実行する方法と、コストを抑えるクエリの作り方についても解説しています。

基本的なクエリ操作
SELECT 文を用いたクエリを、bqコマンドを使って実行可能。

例：gameId と seasonId カラムのみを抽出し、LIMIT を使って表示件数を制限。

GUIと同じ結果がCLIでも得られる。

ドライラン（Dry Run）
--dry_run オプションを付けることで、実行前にデータ処理量（バイト数）を見積もることが可能。

実際のクエリは実行されず、課金も発生しない。

料金やデータ量の事前確認に有用。

bash
コピーする
編集する
bq query --use_legacy_sql=false --dry_run "SELECT gameId, seasonId FROM dataset.table LIMIT 5"
実行結果の確認
--dry_run を外すと、実際にクエリが実行され、結果が返る。

その際に 課金対象 となる。

クエリ料金の考え方
クエリ料金は「処理対象の元データのサイズ」で決まる。

LIMIT で結果件数を絞っても、処理対象が同じであれば料金は変わらない。

カラム数を減らす（SELECT * を避ける）ことで、処理対象のデータ量を削減可能。

条件を追加してデータ範囲を絞ることも、コスト削減に有効。

他の言語からの実行
bq CLI だけでなく、Python・Node.js・Java・Go などのクライアントライブラリからも BigQuery にアクセス可能。

まとめ
bq コマンドを使えば、BigQueryのクエリをCLIから実行できる。

--dry_run を活用してクエリコストを事前確認しよう。

クエリの書き方次第で、料金を大きく削減できる。